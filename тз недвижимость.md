Вот проект документа «Предварительная архитектура и логика системы», который является результатом 1-го этапа.

Этот документ составлен на основе анализа предоставленного ТЗ («потока мыслей») и логики текущих Google-таблиц. Он переводит данные из плоскости Excel в структуру профессионального IT-продукта.

Этот текст можно использовать как основу для договора с разработчиками или как ТЗ для сборки на no-code платформе.

---

# **ТЕХНИЧЕСКОЕ ЗАДАНИЕ (ЭТАП 1: АРХИТЕКТУРА И ЛОГИКА)**

Тема: Система управленческого и финансового учета для агентства недвижимости.

Цель: Переход из Google-таблиц в единую систему с базой данных для исключения ошибок, автоматизации расчетов зарплат и прогнозирования кассовых разрывов.

---

## **1\. Общая структура системы**

Система будет состоять из 4-х взаимосвязанных модулей. Данные вводятся один раз в «Сделках», а в остальные разделы попадают автоматически.

### **Карта разделов (Меню):**

1. **Сделки (Операционный блок)** — реестр всех операций, заменяет таблицу «Агенты рабочая штат».  
2. **Финансы / P\&L (Отчет о прибылях)** — учет доходов и расходов компании, заменяет вкладку «Вложения AB 2025».  
3. **Казначейство (Планирование)** — управление счетами и кассовыми разрывами, заменяет вкладку «Моя рабочая».  
4. **Команда (Справочники)** — база сотрудников, настройки процентов комиссий.

---

## **2\. Анализ данных и Сущности (База данных)**

Здесь мы фиксируем, какие данные хранит система и как они связаны.

### **2.1. Сущность «Сотрудник» (Users)**

*Справочник всех людей, влияющих на деньги.*

* **Основные данные:** ФИО, Роль (Агент/РОП/Бухгалтер/Админ), Статус (Активен/Уволен — для статистики «текучки»).  
* **Фин. настройки:**  
  * Базовая ставка Агента (%).  
  * Базовая ставка РОПа (%).  
  * *Важно:* Система должна хранить «Историю изменений ставки», чтобы пересчет старых сделок не ломал цифры прошлого.

### **2.2. Сущность «Сделка» (Deals) — *Ядро системы***

Заменяет таблицу «Агенты рабочая штат».

Каждая сделка — это отдельная карточка со своим жизненным циклом.

* **Поля карточки (Вводные):**  
  * Дата брони (→ определяет *Месяц Продаж*).  
  * Дата сделки (→ определяет *Месяц Выручки*).  
  * Ответственный Агент (выбор из списка).  
  * Ответственный РОП (подтягивается автоматически от Агента).  
  * Клиент (Покупатель/Продавец), Объект, Цена.  
  * Признаки: Юр. услуги (Да/Нет), Тип договора (Эксклюзив/Подбор/Застройщик).  
* **Финансы сделки (Расчетные):**  
  * Комиссия Агентства (Вал) — *Ввод вручную*.  
  * Комиссия РОПа и Агента — *Авторасчет по формуле (см. раздел 3\)*.  
  * Затраты (Налоги, Брокер, Юрист).  
  * Чистая прибыль сделки.  
* **Статус (Воронка):**  
  * Набор статусов: Задаток → На регистрации → Ждем счет → На оплате → Закрыта (или Срыв).

### **2.3. Сущность «Финансовая операция» (CashFlow)**

*Единая база всех транзакций.*

* **Тип:** Приход / Расход.  
* **Статья:** Аренда, ЗП, Маркетинг, Роялти (справочник статей).  
* **Счет/Кошелек:** Сбер, Альфа, Сейф, Модуль.  
* **Дата:** Плановая (когда ждем) и Фактическая (когда случилось).

---

## **3\. Формализация Бизнес-Логики (Правила расчетов)**

Это «математический мозг» системы. Программист должен реализовать эти правила.

### **3.1. Каскадный расчет прибыли по сделке («Водопад»)**

Расчет внутри карточки сделки происходит строго в таком порядке:

1. **Валовая комиссия (Gross)** \= Вводится вручную (на основе договора).  
2. **(-) Налоги** \= Валовая комиссия \* %Налога (настраиваемый параметр, напр. 6% или 7%).  
3. **(-) Внешние расходы** \= Комиссия стороннего брокера (Столбец T) \+ Доп. затраты.  
4. **(=) Очищенная база** \= Вал \- Налоги \- Внешние расходы.  
5. **(-) Комиссия РОПа** \= Очищенная база \* %РОПа (или от Вала — *требует уточнения настройки*).  
6. **(-) Комиссия Агента** \= Очищенная база \* %Агента.  
7. **(=) Чистая прибыль компании (Net Profit)** \= Остаток после всех вычетов.

*Важно для интерфейса:* Поля комиссий рассчитываются автоматически, но должны быть **доступны для ручной корректировки** (на случай индивидуальных договоренностей по конкретной сделке).

### **3.2. Логика Статусов и Дашборда**

Система автоматически суммирует показатели в зависимости от статуса сделки (аналог «Красной шапки» в таблице):

* Если статус **«Задаток / Бронь»** → Сумма идет в виджет **«Ожидаю в задатках»** (Прогноз).  
* Если статус **«На регистрации / Ждем счет»** → Сумма идет в виджет **«На оплате»** (Дебиторка).  
* Если статус **«Закрыта / Деньги пришли»**:  
  1. Сумма фиксируется как **Выручка (Факт)**.  
  2. Данные передаются в модуль «Финансы P\&L».  
  3. Начисляется ЗП агенту (появляется долг перед сотрудником).

### **3.3. Логика Кассового Разрыва (Модуль «Планирование»)**

Заменяет логику вкладки «Моя рабочая».

Система строит прогноз на каждый будущий месяц по формуле:

$$ \\text{Баланс} \= (\\text{Деньги на счетах сейчас}) \+ (\\text{Ожидаемый приход}) \- (\\text{Обязательные расходы}) $$

* **Деньги на счетах:** Сумма остатков (Сбер \+ Альфа \+ Сейф...).  
* **Ожидаемый приход:** Сумма сделок со статусами «На регистрации/На оплате» с планируемой датой закрытия в этом месяце.  
* **Обязательные расходы:** Шаблон расходов (Аренда, ЗП фикс, Роялти), скопированный из предыдущего месяца.

*Индикация:* Если Баланс \< 0, месяц подсвечивается **КРАСНЫМ** (Кассовый разрыв).

---

## **4\. Ролевая модель (Кто что видит)**

| Роль | Доступ к Сделкам | Доступ к Финансам (Расходы) | Зарплаты |
| :---- | :---- | :---- | :---- |
| **Агент** | Видит только свои | Нет доступа | Видит только свой прогноз ЗП |
| **РОП** | Видит отдел | Нет доступа | Видит комиссии отдела |
| **Владелец** | Полный доступ | Полный доступ (P\&L, Кассовый разрыв) | Полный доступ |
| **Бухгалтер** | Просмотр статусов | Ввод расходов, подтверждение оплат | Ведомости на выплату |

---

## **5\. Описание Интерфейса (UX \- Экраны)**

1. **Главный Дашборд:**  
   * Верхние карточки (KPI): Ожидаю итого, В задатках, На оплате, Чистая прибыль мес.  
   * График: План/Факт выручки.  
2. **Реестр Сделок:**  
   * Таблица с фильтрами (по дате, по агенту, по статусу).  
   * Цветовая маркировка строк (как в Excel).  
3. **Карточка Сделки (Форма):**  
   * Ввод данных о клиенте.  
   * Блок «Финансовый калькулятор» (авто-расчет комиссий при вводе цены).  
4. **Раздел «Финансы» (P\&L):**  
   * Таблица расходов по месяцам (строки — статьи затрат, столбцы — месяцы).  
   * Автоматическая строка «Выручка» (тянется из сделок).  
   * Автоматический расчет Рентабельности.  
5. **Раздел «Платежный календарь»:**  
   * Ввод остатков по счетам.  
   * Таблица прогноза кассовых разрывов.

---

## **6\. Фиксация неявных договоренностей (Вопросы для уточнения)**

*Перед стартом программирования нужно утвердить эти пункты, чтобы избежать переделок:*

1. **База расчета комиссий:** Агент получает % от всей суммы, которая зашла в компанию (Gross), или от суммы *после* вычета налога 6% и расходов на юриста (Net)? (В архитектуре выше я заложил вариант "Net", так как это логичнее для бизнеса, но нужно подтверждение).  
2. **Момент начисления:** Зарплата агенту считается "заработанной" (попадает в отчет) в момент смены статуса на "Закрыто" или по дате Сделки?  
3. **Налоги:** Ставка налога (столбец P) фиксированная (например 6%) или вводится вручную для каждой сделки?

Этот документ является готовым техническим концептом для передачи разработчику.

