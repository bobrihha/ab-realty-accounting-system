generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Сотрудники компании
model Employee {
  id            String   @id @default(cuid())
  name          String
  email         String   @unique
  phone         String
  role          Role     // AGENT, ROP, ACCOUNTANT, OWNER
  status        Status   @default(ACTIVE) // ACTIVE, INACTIVE
  department    String?
  hireDate      DateTime
  terminationDate DateTime?
  passwordHash  String?
  baseRateAgent Float?   // Ставка агента в %
  baseRateROP   Float?   // Ставка РОПа в %
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  managerId     String?

  // Связи
  dealsAsAgent  Deal[]   @relation("AgentDeals")
  dealsAsROP    Deal[]   @relation("ROPDeals")
  commissionRates CommissionRate[]
  manager       Employee? @relation("EmployeeManager", fields: [managerId], references: [id])
  subordinates  Employee[] @relation("EmployeeManager")
  payrollAccruals PayrollAccrual[]

  @@map("employees")
}

// История изменения ставок комиссий
model CommissionRate {
  id            String   @id @default(cuid())
  employeeId    String
  rate          Float    // Ставка в %
  type          RateType // AGENT, ROP
  effectiveDate DateTime
  createdAt     DateTime @default(now())

  // Связи
  employee Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@map("commission_rates")
}

// Сделки
model Deal {
  id              String       @id @default(cuid())
  client          String
  object          String
  price           Float
  commission      Float        // Комиссия агентства
  agentId         String
  ropId           String?
  status          DealStatus   @default(DEPOSIT)
  depositDate     DateTime
  dealDate        DateTime?
  plannedCloseDate DateTime?
  contractType    ContractType @default(EXCLUSIVE)
  legalServices   Boolean      @default(false)
  legalServicesAmount Float    @default(0) // Стоимость юр. услуг
  notes           String?
  taxRate         Float        @default(6) // Ставка налога в %
  // Расходы по сделке (разбивка)
  brokerExpense   Float        @default(0) // Брокер / ипотека
  lawyerExpense   Float        @default(0) // Юрист
  referralExpense Float        @default(0) // Рекомендация
  otherExpense    Float        @default(0) // Прочее
  externalExpenses Float       @default(0) // Сумма расходов (для совместимости/быстрых агрегатов)
  ropCommission   Float?       // Комиссия РОПа (рассчитывается)
  agentCommission Float?       // Комиссия агента (рассчитывается)
  netProfit       Float?       // Чистая прибыль (рассчитывается)
  ropRateApplied  Float?
  agentRateApplied Float?
  commissionsManual Boolean    @default(false)
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  // Связи
  agent           Employee @relation("AgentDeals", fields: [agentId], references: [id])
  rop             Employee? @relation("ROPDeals", fields: [ropId], references: [id])
  payrollAccruals PayrollAccrual[]

  @@map("deals")
}

// Финансовые операции
model CashFlow {
  id          String       @id @default(cuid())
  type        CashFlowType // INCOME, EXPENSE
  amount      Float
  category    String
  status      PaymentStatus @default(PLANNED) // PLANNED (план), PAID (факт)
  plannedDate DateTime
  actualDate  DateTime?
  description String?
  accountId   String?
  createdAt   DateTime     @default(now())

  account     Account?     @relation(fields: [accountId], references: [id], onDelete: SetNull)
  payrollPayments PayrollPayment[]

  @@map("cash_flow")
}

// Счета и кошельки
model Account {
  id        String      @id @default(cuid())
  name      String      @unique
  balance   Float       @default(0)
  type      AccountType // BANK, CASH, DIGITAL
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  cashFlows CashFlow[]
  payrollPayments PayrollPayment[]

  @@map("accounts")
}

// Прогноз кассовых разрывов
model CashFlowForecast {
  month            String     @id
  openingBalance   Float
  expectedIncome   Float
  plannedExpenses  Float
  closingBalance   Float
  status           ForecastStatus
  createdAt        DateTime   @default(now())
  updatedAt        DateTime   @updatedAt

  @@map("cash_flow_forecasts")
}

// Начисления и выплаты ЗП (по сделкам)
model PayrollAccrual {
  id         String       @id @default(cuid())
  dealId     String
  employeeId String
  type       PayrollType
  amount     Float
  accruedAt  DateTime
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt

  deal       Deal         @relation(fields: [dealId], references: [id])
  employee   Employee     @relation(fields: [employeeId], references: [id])
  payments   PayrollPayment[]

  @@unique([dealId, employeeId, type])
  @@map("payroll_accruals")
}

model PayrollPayment {
  id         String        @id @default(cuid())
  accrualId  String
  amount     Float
  paidAt     DateTime
  accountId  String
  cashFlowId String?       @unique
  description String?
  createdAt  DateTime      @default(now())

  accrual    PayrollAccrual @relation(fields: [accrualId], references: [id], onDelete: Cascade)
  account    Account       @relation(fields: [accountId], references: [id])
  cashFlow   CashFlow?     @relation(fields: [cashFlowId], references: [id], onDelete: SetNull)

  @@map("payroll_payments")
}

// Юридические услуги (отдельные, не в сделках)
model LegalService {
  id          String   @id @default(cuid())
  client      String
  amount      Float
  serviceDate DateTime
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("legal_services")
}

// Enum'ы
enum Role {
  AGENT
  ROP
  ACCOUNTANT
  OWNER
}

enum Status {
  ACTIVE
  INACTIVE
}

enum DealStatus {
  DEPOSIT
  REGISTRATION
  WAITING_INVOICE
  WAITING_PAYMENT
  CLOSED
  CANCELLED
}

enum ContractType {
  EXCLUSIVE
  SELECTION
  DEVELOPER
  SELLER
}

enum PayrollType {
  AGENT
  ROP
}

enum PaymentStatus {
  PLANNED
  PAID
}

enum RateType {
  AGENT
  ROP
}

enum CashFlowType {
  INCOME
  EXPENSE
}

enum AccountType {
  BANK
  CASH
  DIGITAL
}

enum ForecastStatus {
  POSITIVE
  WARNING
  CRITICAL
}
